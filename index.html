<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Chat Calendar</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icon-192.png" />

    <style>
:root {
  --bg-gradient-top: #f2f2f7;
  --bg-gradient-bottom: #ffffff;
  --card-bg: rgba(255, 255, 255, 0.9);
  --card-border: rgba(15, 23, 42, 0.06);
  --card-radius: 24px;
  --card-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
  --accent: #007aff; /* iOS è“ */
  --accent-soft: rgba(0, 122, 255, 0.08);
  --text-primary: #111827;
  --text-secondary: #4b5563;
  --muted: #9ca3af;
  --danger: #fb7185;

  --top-bar-height: 52px;
  --safe-horizontal: 15px;
}

* {
  box-sizing: border-box;
}

html,
body {
  margin: 0;
  padding: 0;
  height: 100%;
}

[hidden] {
  display: none !important;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
  background: linear-gradient(180deg, var(--bg-gradient-top), var(--bg-gradient-bottom));
  color: var(--text-primary);
}

#app-root {
  min-height: 100vh;
  position: relative;
  color: var(--text-primary);
}

/* é¡¶éƒ¨å¯¼èˆª */

.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--top-bar-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--safe-horizontal);
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(18px);
  border-bottom: 1px solid rgba(15, 23, 42, 0.06);
  z-index: 10;
}

.top-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}

.icon-button {
  border: none;
  background: none;
  padding: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  touch-action: manipulation;
  color: inherit;
}

/* ä¸“é—¨ç»™å·¦ä¸Šè§’â€œä¸‰â€è¿™ä¸ªæŒ‰é’®ç”¨çš„æ ·å¼ */
.icon-button-menu {
  font-size: 18px;
  font-weight: 600;
  line-height: 1;
  padding-top: 2px; /* ç¨å¾®å¾€ä¸‹å‹ä¸€ç‚¹ï¼Œè®©â€œä¸‰â€å±…ä¸­ä¸€ç‚¹ */
}

.icon-button:active {
  background: rgba(148, 163, 184, 0.2);
}

.icon-bar {
  display: block;
  width: 14px;
  height: 2px;
  border-radius: 999px;
  background: var(--text-primary);
  margin: 1.5px 0;
}

.avatar-button .avatar-circle {
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle at 30% 0%, #e0edff 0, #ffffff 60%);
}

.avatar-glyph {
  font-size: 14px;
}

/* å±å¹•å®¹å™¨ */

.screen {
  min-height: 100vh;
  padding-top: var(--top-bar-height);
}

.screen-calendar {
  position: relative;
  overflow: hidden;
}

.background-layer {
  position: fixed;
  inset: 0;
  background:
    url("bg-winter.jpg") center/cover no-repeat;
  z-index: -1;
}

/* æ—¥å†ä¸»å¡ç‰‡ */

.calendar-card {
  margin: 100px var(--safe-horizontal);
  border-radius: var(--card-radius);
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  box-shadow: var(--card-shadow);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* é¡¶éƒ¨è“è‰²å¤´éƒ¨æ•´å— */
.card-header {
  background: #EEF9FF;                 /* â† å¤´éƒ¨åº•è‰²ï¼šåœ¨è¿™é‡Œæ¢é¢œè‰² */
  border-bottom: 1px solid rgba(15, 23, 42, 0.06);
  min-height: 100px;                    /* â† å¤´éƒ¨é«˜åº¦ï¼Œæƒ³æ›´çŸ®/æ›´é«˜è‡ªå·±æ”¹ */
  padding: 0 16px;
  display: flex;                       /* è®©æ•´ä¸ªå¤´éƒ¨æˆä¸º flex å®¹å™¨ */
  align-items: center;                 /* å‚ç›´å±…ä¸­é‡Œé¢æ‰€æœ‰å†…å®¹ */
}

/* é‡Œé¢çš„å·¦å³ç»“æ„ï¼šå·¦è¾¹æ–‡å­— / å³è¾¹æŒ‰é’® */
.card-header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  width: 100%;
}

/* å·¦è¾¹ä¸‰è¡Œæ–‡å­—æ•´ä½“ */
.card-header-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
  justify-content: center;            /* åœ¨è“è‰²å—é‡Œå‚ç›´å±…ä¸­å¯¹é½ */
}

/* ç¬¬ä¸€è¡Œï¼šNovemberâ¤Night è¿™ä¸€è¡Œ */
.calendar-title {
  font-size: 20px;                     /* â† è¿™é‡Œæ”¹æ ‡é¢˜å­—å·ï¼Œæ¯”å¦‚ 18 / 20 / 22 */
  font-weight: 700;
  letter-spacing: 0.02em;
  color: var(--accent);                /* ç”¨é‡ç‚¹è‰²ï¼Œæƒ³å›ºå®šå°±æ”¹æˆ #111827 */
}

/* ç¬¬äºŒè¡Œï¼šå¹´æœˆï¼Œæ¯”å¦‚ 2025å¹´12æœˆ */
.month-label {
  font-size: 14px;                     /* â† åœ¨è¿™é‡Œæ”¹å¹´æœˆå­—å·ï¼Œ11~14 éƒ½å¯ */
  font-weight: 700;
  color: #FFFFFF;                      /* æƒ³æ›´æ·¡å°±ç”¨ #4b5563 */
}

/* å³è¾¹ä¸¤ä¸ªåˆ‡æ¢æœˆä»½æŒ‰é’®åŒºåŸŸ */
.card-header-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* å·¦å³åˆ‡æœˆæŒ‰é’®ï¼šå°ºå¯¸å’Œå³ä¸‹è§’ + ä¸€è‡´ */
.month-nav-btn {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  border: none;
  background: var(--accent);           /* è·Ÿé‡ç‚¹è‰²è”åŠ¨ */
  color: #ffffff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;                     /* â† ç®­å¤´å¤§å°åœ¨è¿™é‡Œè°ƒ */
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0);
}

.month-nav-btn:active {
  transform: translateY(1px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.24);
}


.month-nav-btn:active {
  transform: translateY(1px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.24);
}

.card-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.month-label {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.02em;
  color: var(--text-primary);
}

.card-hero {
  display: none;
}

.card-body {
  padding: 12px 10px 4px;
  background: #ffffff; /* ä¸»ä½“ç™½è‰²åŒºåŸŸ */
}


.weekday-row {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 4px;
}

.weekday-row span {
  text-align: center;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-auto-rows: 64px;
  gap: 4px;
}

/* æ—¥å†å°æ ¼ */

.day-cell {
  position: relative;
  border-radius: 14px;
  padding: 6px 8px 1px;
  font-size: 11px;
  background: #f2f2f2; /* æ—¥å†å°æ ¼å­é¢œè‰² */
  border: 1px solid rgba(15, 23, 42, 0.04);
  display: flex;
  flex-direction: column;
  cursor: pointer;
  text-align: left;
  color: var(--text-primary);
}

.day-cell.empty {
  opacity: 0;
  pointer-events: none;
}

.day-cell-date {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-top: -2px;    /* è½»è½»å¾€ä¸‹æ¨ä¸€ç‚¹ */
}

.day-cell-count {
  margin-top: 6px;          /* é—´è·ç¨å¾®ç¼©ä¸€ç‚¹ */
  font-size: 8px;           /* âœ… ä» 11px æ”¹æˆ 9px */
  text-align: center;
  white-space: nowrap;      /* ä»ç„¶å¼ºåˆ¶ä¸€è¡Œ */
  text-overflow: ellipsis;  /* è¶…å‡ºå°±çœç•¥å·ï¼Œä¸æ’‘ç ´æ ¼å­ */
  overflow: hidden;
  color: var(--text-primary);
}

.day-cell-dot-wrapper {
  margin-top: auto;
  display: flex;
  justify-content: flex-end;
  min-height: 16px;
  padding-bottom: -3px;   /* âœ… åœ†ç‚¹ç¦»åº•è¾¹è¿œä¸€ç‚¹ */
}

.day-cell-dot {
  min-width: 12px;
  height: 12px;
  border-radius: 999px;
  font-size: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #f3f4f6;
  color: var(--text-secondary);
  margin-right: -3px;     /* âœ…åœ†ç‚¹ç¦»å³è¾¹è¿œä¸€ç‚¹ */
}

.day-cell.has-data {
  /* å»æ‰åŸæ¥çš„æ¸å˜ï¼Œåªä¿ç•™ç•¥å¾®å¼ºè°ƒçš„è¾¹æ¡† */
  background: #ffffff;                /* ç™½è‰² */
  border-color: #E6E6E6;   /* è½»è½»æç¤ºâ€œè¿™é‡Œæœ‰èŠå¤©è®°å½•â€ */
  cursor: pointer;
}

/* æ²¡æœ‰èŠå¤©è®°å½•çš„æ ¼å­ï¼šä¸å“åº”ç‚¹å‡» */
.day-cell:not(.has-data) {
  cursor: default;       /* é¼ æ ‡æ˜¯æ™®é€šç®­å¤´ */
  pointer-events: none;  /* âœ… å½»åº•ç¦æ­¢ç‚¹å‡» */
}

.day-cell.today {
  border-color: var(--accent);
}

.day-cell.selected {
  background: var(--accent);          /* âœ… æ•´å—ç”¨é‡ç‚¹è‰² */
  border-color: var(--accent);
  box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
  color: #ffffff;                     /* é»˜è®¤æ–‡å­—æ”¹æˆç™½è‰² */
}

/* è¢«é€‰ä¸­æ—¶ï¼Œæ—¥æœŸ + ä¸­é—´çš„æ¡æ•°æ–‡å­—éƒ½åç™½ */
.day-cell.selected .day-cell-date,
.day-cell.selected .day-cell-count {
  color: #ffffff;
}

/* å³ä¸‹è§’å°åœ†ç‚¹ï¼šç™½åº• + é‡ç‚¹è‰²æ•°å­—ï¼Œå½¢æˆâ€œåç™½â€æ•ˆæœ */
.day-cell.selected .day-cell-dot {
  background: #ffffff;
  color: var(--accent);
}

.card-footer {
  padding: 10px 12px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid rgba(15, 23, 42, 0.04);
}

.legend {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 10px;
  color: var(--muted);
}

.legend-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.legend-swatch {
  width: 12px;
  height: 8px;
  border-radius: 999px;
}

.legend-selected {
  background: var(--accent);
}

.legend-today {
  background: rgba(148, 163, 184, 0.9);
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.8);
}

/* å¯¼å…¥æŒ‰é’® FAB */

.fab {
  position: relative;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 999px;
  background: var(--accent);
  box-shadow: 0 12px 24px rgba(0, 122, 255, 0.1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #ffffff;
}

.fab-plus {
  font-size: 16px;
  line-height: 1;
  margin-top: -1px;
}

.fab:active {
  transform: translateY(1px);
  box-shadow: 0 8px 18px rgba(0, 122, 255, 0.3);
}

/* å½“æ—¥è¯¦æƒ…é¡µ */

.screen-day {
  background: linear-gradient(180deg, var(--bg-gradient-top), var(--bg-gradient-bottom));
  display: flex;
  flex-direction: column;
}

.sub-header {
  height: var(--top-bar-height);
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 var(--safe-horizontal);
  border-bottom: 1px solid rgba(15, 23, 42, 0.06);
  background: rgba(255, 255, 255, 0.9);
}

.sub-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.back-button {
  font-size: 18px;
  color: var(--text-primary);
}

.day-content {
  flex: 1;
  padding: 10px var(--safe-horizontal) 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  color: var(--text-primary);
}

.empty-state {
  font-size: 13px;
  color: var(--muted);
  text-align: center;
  margin-top: 40px;
}

.bubble-row {
  display: flex;
}

.bubble-row.user {
  justify-content: flex-end;
}

.bubble-row.assistant {
  justify-content: flex-start;
}

.bubble-row.system {
  justify-content: center;
}

.bubble {
  max-width: 78%;
  padding: 8px 10px;
  border-radius: 16px;
  font-size: 13px;
  line-height: 1.4;
  position: relative;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.bubble-user {
  background: #e5f2ff;
  border: 1px solid rgba(0, 122, 255, 0.4);
}

.bubble-assistant {
  background: #f3f4f6;
  border: 1px solid rgba(148, 163, 184, 0.6);
}

.bubble-system {
  background: #e5e7eb;
  color: #111827;
  border-radius: 999px;
  font-size: 11px;
}

.bubble-meta {
  margin-top: 3px;
  font-size: 10px;
  color: var(--muted);
  text-align: right;
}

/* åº•éƒ¨å¼¹å‡ºæ›´å¤š */

/* ===== å½“æ—¥èŠå¤©ç•Œé¢ ===== */

.screen-day {
  background: linear-gradient(180deg, #f3f4f6 0%, #ffffff 18%);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* é¡¶éƒ¨è¿”å›æ  */
.sub-header {
  height: 48px;
  padding: 0 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
}

.back-button {
  border-radius: 999px;
  padding: 4px 8px;
  font-size: 16px;
}

.sub-title {
  font-size: 14px;
  font-weight: 600;
  color: #111827;
}

/* èŠå¤©å†…å®¹åŒº */
.day-content {
  flex: 1;
  padding: 12px 10px 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* æ¯ä¸€è¡Œæ°”æ³¡çš„åŸºç¡€å¸ƒå±€ */
.bubble-row {
  display: flex;
  gap: 6px;
}

/* å·¦ï¼šåŠ©æ‰‹æ°”æ³¡ä¸€åˆ— */
.bubble-row.assistant {
  justify-content: flex-start;
}

/* å³ï¼šç”¨æˆ·æ°”æ³¡ä¸€åˆ— */
.bubble-row.user {
  justify-content: flex-end;
}

/* ä¸­ï¼šç³»ç»Ÿæç¤ºä¸€åˆ— */
.bubble-row.system {
  justify-content: center;
}

/* æ°”æ³¡æœ¬ä½“ */
.bubble {
  max-width: 80%;
  border-radius: 18px;
  padding: 8px 10px;
  box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 14px;
  line-height: 1.5;
}

/* å·¦ä¾§åŠ©æ‰‹æ°”æ³¡ï¼šç™½åº• */
.bubble-assistant {
  background: #ffffff;
  color: #111827;
}

/* å³ä¾§ç”¨æˆ·æ°”æ³¡ï¼šé‡ç‚¹è‰² */
.bubble-user {
  background: var(--accent);
  color: #ffffff;
}

/* æ–‡æœ¬éƒ¨åˆ† */
.bubble-text {
  white-space: pre-wrap;
  word-break: break-word;
}

/* æ°”æ³¡å†…å¯Œæ–‡æœ¬æ ·å¼ */
.bubble-text strong {
  font-weight: 600;
}

.bubble-text em {
  font-style: normal;
  color: var(--accent);
}

.bubble-text code {
  font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Courier New",
    monospace;
  font-size: 12px;
  padding: 1px 4px;
  border-radius: 4px;
  background: rgba(15, 23, 42, 0.06);
}

/* > å¼•ç”¨ è¡Œ */
.msg-quote {
  border-left: 3px solid rgba(148, 163, 184, 0.8);
  padding-left: 8px;
  margin: 4px 0;
  color: #4b5563;
  font-size: 13px;
}

/* æ°”æ³¡ä¸‹æ–¹çš„ metaï¼šåå­— Â· æ—¶é—´ Â· ä¼šè¯ */
.bubble-meta {
  margin-top: 2px;
  font-size: 11px;
  opacity: 0.9;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.bubble-meta span::after {
  content: "Â·";
  margin: 0 2px;
}

.bubble-meta span:last-child::after {
  content: "";
}

/* meta ä¸­çš„è§’è‰²åç”¨ä¸€ç‚¹ç‚¹å­—é‡åŒºåˆ† */
.bubble-name {
  font-weight: 500;
}

/* ç³»ç»Ÿæ¶ˆæ¯ï¼šä¸­é—´ç°æ¡ */
.system-label {
  max-width: 90%;
  font-size: 12px;
  color: #6b7280;
  background: rgba(243, 244, 246, 0.9);
  border-radius: 999px;
  padding: 4px 10px;
  text-align: center;
}

.system-meta {
  margin-top: 2px;
  font-size: 11px;
  color: #9ca3af;
  text-align: center;
}

.bottom-sheet-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.2);
  backdrop-filter: blur(8px);
  z-index: 30;
}

.bottom-sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 40;
  border-radius: 18px 18px 0 0;
  background: rgba(255, 255, 255, 0.98);
  border-top: 1px solid rgba(15, 23, 42, 0.08);
  box-shadow: 0 -18px 40px rgba(15, 23, 42, 0.1);
  padding: 12px var(--safe-horizontal) 24px; /* ç¨å¾®å¤šä¸€ç‚¹å†…è¾¹è· */
  min-height: 35vh;                          /* å…³é”®ï¼šæœ€å°‘å å±å¹• 45% é«˜ */
}

/* æ˜¾ç¤ºè®¾ç½®å¼¹çª—é®ç½© */
.settings-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(10px);
  z-index: 50;
}

/* å¼¹çª—æœ¬ä½“ */
.settings-modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  pointer-events: none; /* é»˜è®¤ä¸æŠ¢äº‹ä»¶ï¼Œå†…éƒ¨å†å¼€å¯ */
}

.settings-inner {
  width: 88%;
  max-width: 360px;
  border-radius: 24px;
  background: rgba(255, 255, 255, 0.98);
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
  padding: 16px 18px 18px;
  pointer-events: auto;
}

/* å¤´éƒ¨åŒºåŸŸ */
.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.settings-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.settings-close {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  border: none;
  background: #e5e7eb;
  color: #111827;
  font-size: 18px;
  line-height: 1;
  cursor: pointer;
}

.settings-close:active {
  background: #d1d5db;
}

.settings-desc {
  font-size: 11px;
  color: var(--muted);
  margin: 0 0 10px;
}

/* è¡¨å• */
.settings-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.settings-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.settings-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.settings-input {
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.6);
  padding: 0 12px;
  font-size: 13px;
  outline: none;
}

.settings-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

/* é¢œè‰²é€‰æ‹© */
.settings-accent-options {
  display: flex;
  gap: 10px;
  margin-top: 2px;
}

.accent-swatch {
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 2px solid transparent;
  background: #111827;
  cursor: pointer;
}

/* å››ä¸ªå…·ä½“é¢œè‰²ï¼šé»‘ / ç´« / è“ç»¿ / ç²‰ */
/* 01 å¤œç©ºè“ */
.accent-swatch[data-accent-key="black"] {
  background: #1e293b; /* midnight blue */
}

/* 02 è‘¡è„ç´« */
.accent-swatch[data-accent-key="purple"] {
  background: #5C1A87; /* indigo */
}

/* 03 æ£®æ—ç»¿ */
.accent-swatch[data-accent-key="teal"] {
  background: #0B6C5B; /* mint teal */
}

/* 04 ç³–éœœç²‰ */
.accent-swatch[data-accent-key="pink"] {
  background: #ED778D; /* soft rose */
}

/* å½“å‰é€‰ä¸­é¢œè‰²ï¼ŒåŠ ç™½è¾¹ */
.accent-swatch.selected {
  border-color: #ffffff;
  box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.35);
}

/* åº•éƒ¨æŒ‰é’® */
.settings-actions {
  margin-top: 8px;
  display: flex;
  justify-content: flex-end;
}

.settings-save {
  min-width: 80px;
  height: 34px;
  border-radius: 999px;
  border: none;
  background: #047857;
  color: #ffffff;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}

.settings-save:active {
  background: #065f46;
}


.sheet-handle {
  width: 36px;
  height: 4px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.6);
  margin: 4px auto 10px;
}

.sheet-title {
  font-size: 14px;
  font-weight: 500;
  margin: 0 0 8px;
  color: var(--text-primary);
}

.sheet-item {
  width: 100%;
  text-align: left;
  padding: 10px 4px;
  border-radius: 12px;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-size: 14px;
}

.sheet-item:active {
  background: rgba(0, 122, 255, 0.12);
}

/* å“åº”å¼å¾®è°ƒï¼šç‰¹åˆ«çŸ®çš„å±å¹•å‡å°‘ä¸Šä¸‹å¤–è¾¹è· */

@media (max-height: 700px) {
  .calendar-card {
    margin-top: 90px;
    margin-bottom: 80px;
  }
}

/* èŠå¤©ç•Œé¢ï¼šæŠŠå°å¯¼èˆªæ¡ + å¤´éƒ¨æ—¥æœŸä¿¡æ¯å¡éƒ½éšè— */
.sub-header,
.day-summary,
#day-summary {
  display: none;
}

.screen-day .day-content {
  padding-top: 12px;
}

/* å³ä¸‹è§’æ‚¬æµ®â€œå›å®¶â€æŒ‰é’®ï¼Œä»…è´Ÿè´£æ ·å¼ï¼Œæš‚æ—¶ä¸å†™åŠŸèƒ½ */
.back-floating {
  position: fixed;                      /* å›ºå®šåœ¨è§†å£ï¼Œä¸è·Ÿå†…å®¹æ»šåŠ¨ */
  right: 16px;                          /* è·ç¦»å³è¾¹ 16px */
  bottom: 24px;                         /* è·ç¦»åº•éƒ¨ 24px */
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: var(--accent, #007aff);   /* è·Ÿéšé‡ç‚¹è‰² */
  color: #ffffff;
  font-size: 18px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.35);
  cursor: pointer;
  z-index: 50;                          /* ä¿è¯æµ®åœ¨å†…å®¹ä¸Šé¢ */
}

/* ===== å…¨æ–‡æœç´¢å¼¹çª— ===== */

.search-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(10px);
  z-index: 55;
}

.search-modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  pointer-events: none; /* åªè®©å†…éƒ¨å¡ç‰‡æ¥äº‹ä»¶ */
}

.search-inner {
  width: 90%;
  max-width: 420px;
  max-height: 80vh;
  border-radius: 24px;
  background: rgba(255, 255, 255, 0.98);
  box-shadow: 0 22px 50px rgba(15, 23, 42, 0.35);
  padding: 16px 18px 18px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: auto;
}

/* å¤´éƒ¨ */

.search-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.search-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.search-close {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  border: none;
  background: #e5e7eb;
  color: #111827;
  font-size: 18px;
  line-height: 1;
  cursor: pointer;
}

.search-close:active {
  background: #d1d5db;
}

.search-desc {
  font-size: 11px;
  color: var(--muted);
  margin: 4px 0 6px;
}

/* è¾“å…¥æ¡† */

.search-form {
  margin-bottom: 2px;
}

.search-input {
  width: 100%;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.9);
  padding: 0 12px;
  font-size: 13px;
  outline: none;
}

.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

/* ç»Ÿè®¡ + ç»“æœ */

.search-count {
  font-size: 11px;
  color: var(--muted);
}

.search-results {
  margin-top: 4px;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-right: 2px;
}

/* æ¯ä¸€æ¡ç»“æœ */

.search-result-card {
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
  padding: 8px 10px;
  cursor: pointer;
}

.search-result-card:active {
  transform: translateY(1px);
  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
}

.search-result-meta {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 4px;
}

.search-result-body {
  font-size: 13px;
  color: var(--text-primary);
  line-height: 1.5;
  white-space: pre-line;
}

.search-empty {
  font-size: 13px;
  color: var(--muted);
  text-align: center;
  padding: 24px 0 8px;
}
/* ===== ä¸‹é›ªç‰¹æ•ˆ ===== */
.snow-layer {
  position: fixed;
  inset: 0;
  pointer-events: none;         /* ä¸æŒ¡ä½ ç‚¹æŒ‰é’® */
  z-index: 8;                   /* åœ¨ç•Œé¢ä¸Šæ–¹ï¼Œä¸‹é›ªç›–åœ¨ UI å‰é¢ */
  overflow: hidden;
}

.snowflake {
  position: absolute;
  top: -10px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.98);           /* æ›´ç™½ä¸€ç‚¹ */
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.95);  /* å‘å…‰æ›´å¼º */
  opacity: 1;
  filter: blur(0.3px);                             /* å¾®å¾®ç³Šä¸€ç‚¹ï¼Œåƒé›ªç‰‡ */
  animation-name: snow-fall;
  animation-timing-function: linear;
  animation-iteration-count: infinite;
}

@keyframes snow-fall {
  0% {
    transform: translate3d(0, -10px, 0);
    opacity: 0;
  }
  10% {
    opacity: 0.9;
  }
  100% {
    transform: translate3d(20px, 110vh, 0);
    opacity: 0;
  }
}
    </style>
  </head>
  <body>
    <div id="app-root">
      <!-- é¡¶éƒ¨å¯¼èˆªæ¡ -->
      <header class="top-bar">
      <button class="icon-button icon-button-menu" id="btn-more" aria-label="æ›´å¤š">
        ä¸‰
      </button>

        <div class="top-title" id="top-title">Chat Calendar</div>
        <button class="icon-button avatar-button" id="btn-profile" aria-label="ä¸ªäººè®¾ç½®">
          <div class="avatar-circle">
            <span class="avatar-glyph">ğŸ™‚</span>
          </div>
        </button>
      </header>

      <!-- ä¸»ç•Œé¢ï¼šæ—¥å†è§†å›¾ -->
      <main class="screen screen-calendar" id="screen-calendar">
        <!-- èƒŒæ™¯å±‚ï¼šæ•´å±ä¸»é¢˜èƒŒæ™¯ -->
        <div class="background-layer"></div>

        <!-- æ‚¬æµ®æ—¥å†å¡ç‰‡ -->
        <section class="card calendar-card">
        <header class="card-header">
  <div class="card-header-inner">
    <div class="card-header-left">
      <!-- â‘  è‡ªå®šä¹‰æ—¥å†æ ‡é¢˜ï¼šä»¥åå¯ä»¥åšæˆç”¨æˆ·è®¾ç½®ï¼Œç°åœ¨å…ˆå†™æ­» -->
      <div class="calendar-title" id="calendar-title">èŠå¤©æ—¥å†</div>

      <!-- â‘¡ å¹´æœˆï¼šç”± JS åŠ¨æ€å¡«è¿›å» -->
      <div class="month-label" id="month-label"></div>

    </div>

    <!-- å³ä¾§ä¸Šä¸€æœˆ / ä¸‹ä¸€æœˆæŒ‰é’® -->
    <div class="card-header-nav">
      <button
        class="month-nav-btn"
        id="btn-prev-month"
        aria-label="ä¸Šä¸€æœˆ"
        type="button"
      >
        &lt;
      </button>
      <button
        class="month-nav-btn"
        id="btn-next-month"
        aria-label="ä¸‹ä¸€æœˆ"
        type="button"
      >
        &gt;
      </button>
    </div>
  </div>
</header>

          <section class="card-body">
            <div class="weekday-row" aria-hidden="true">
              <span>SU</span>
              <span>MO</span>
              <span>TU</span>
              <span>WE</span>
              <span>TH</span>
              <span>FR</span>
              <span>SA</span>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
          </section>

          <footer class="card-footer">
            <div class="legend">
              <span class="legend-item">
                <span class="legend-swatch legend-selected"></span>
                <span>ç‚¹å‡»æŒ‰é’®ä¸Šä¼ conversations.jsonæ–‡ä»¶</span>
              </span>
                         </div>

            <!-- å³ä¸‹å¯¼å…¥æŒ‰é’® -->
            <button class="fab" id="btn-import" aria-label="å¯¼å…¥èŠå¤©è®°å½•">
              <span class="fab-plus">+</span>
              <input type="file" id="file-input" accept=".json" hidden />
            </button>
          </footer>
        </section>
      </main>

      <!-- å½“æ—¥è¯¦æƒ…é¡µ -->
      <main class="screen screen-day" id="screen-day" hidden>
        <header class="sub-header">
          <button
            class="icon-button back-button"
            id="btn-back-calendar"
            aria-label="è¿”å›æ—¥å†"
          >
            <
          </button>
          <div class="sub-title" id="day-title">0000-00-00</div>
        </header>

        <section class="day-content" id="day-messages">
          <!-- åœ¨è¿™é‡Œæ¸²æŸ“å½“æ—¥ User / Assistant / System æ°”æ³¡ -->
        </section>
      </main>

         <!-- åº•éƒ¨å¼¹å‡ºã€Œæ›´å¤šã€ -->
      <div class="bottom-sheet-backdrop" id="sheet-backdrop" hidden></div>
      <section class="bottom-sheet" id="bottom-sheet" hidden>
        <div class="sheet-handle"></div>
        <h2 class="sheet-title">æ›´å¤šåŠŸèƒ½</h2>
        <button class="sheet-item" id="sheet-search">å…¨æ–‡æœç´¢</button>
        <!-- ä»¥åå¯ä»¥åœ¨è¿™é‡Œç»§ç»­åŠ æ¡ç›®ï¼šç»Ÿè®¡ / å¯¼å‡ºç­‰ -->
      </section>
    </div>

    <!-- æ˜¾ç¤ºè®¾ç½®å¼¹çª—ï¼ˆç‚¹å‡»å¤´åƒæ‰“å¼€ï¼‰ -->
    <div class="settings-backdrop" id="settings-backdrop" hidden></div>
    <section class="settings-modal" id="settings-modal" hidden>
      <div class="settings-inner">
        <header class="settings-header">
          <div class="settings-title">æ˜¾ç¤ºè®¾ç½®</div>
          <button
            type="button"
            class="settings-close"
            id="settings-close"
            aria-label="å…³é—­"
          >
            Ã—
          </button>
        </header>

        <p class="settings-desc">
          è¿™äº›è®¾ç½®åªå½±å“æœ¬åœ°æ˜¾ç¤ºï¼Œä¸ä¼šä¿®æ”¹åŸå§‹èŠå¤©è®°å½•å†…å®¹ã€‚
        </p>

        <form id="settings-form" class="settings-form">
          <div class="settings-field">
            <label class="settings-label" for="settings-user-name">
              User çš„åå­—
            </label>
            <input
              id="settings-user-name"
              class="settings-input"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šUser"
            />
          </div>

          <div class="settings-field">
            <label class="settings-label" for="settings-assistant-name">
              GPT çš„åå­—
            </label>
            <input
              id="settings-assistant-name"
              class="settings-input"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šå°æœº"
            />
          </div>

          <div class="settings-field">
            <label class="settings-label" for="settings-title">
              é¡¶éƒ¨æ ‡é¢˜
            </label>
            <input
              id="settings-title"
              class="settings-input"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šæŸæŸçš„èŠå¤©æ—¥å†"
            />
          </div>

          <div class="settings-field">
            <div class="settings-label">é‡ç‚¹è‰²</div>
            <div class="settings-accent-options">
              <button
                type="button"
                class="accent-swatch"
                data-accent-key="black"
                aria-label="é»‘è‰²"
              ></button>
              <button
                type="button"
                class="accent-swatch"
                data-accent-key="purple"
                aria-label="ç´«è‰²"
              ></button>
              <button
                type="button"
                class="accent-swatch"
                data-accent-key="teal"
                aria-label="è“ç»¿"
              ></button>
              <button
                type="button"
                class="accent-swatch"
                data-accent-key="pink"
                aria-label="ç²‰è‰²"
              ></button>
            </div>
          </div>

          <div class="settings-actions">
            <button type="submit" class="settings-save">
              ä¿å­˜
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- å…¨æ–‡æœç´¢å¼¹çª— -->
    <div class="search-backdrop" id="search-backdrop" hidden></div>
    <section class="search-modal" id="search-modal" hidden>
      <div class="search-inner">
        <header class="search-header">
          <div class="search-title">å…¨æ–‡æœç´¢</div>
          <button
            type="button"
            class="search-close"
            id="search-close"
            aria-label="å…³é—­"
          >
            Ã—
          </button>
        </header>

        <p class="search-desc">
          åœ¨æ‰€æœ‰æ—¥æœŸçš„èŠå¤©è®°å½•é‡ŒæŒ‰å…³é”®å­—æŸ¥æ‰¾ï¼Œç»“æœæŒ‰æ—¶é—´æ’åºã€‚
        </p>

        <form id="search-form" class="search-form">
          <input
            id="search-input"
            class="search-input"
            type="text"
            placeholder="è¾“å…¥å…³é”®è¯ï¼Œä¾‹å¦‚ï¼šå¤©æ°”å¦‚ä½•"
          />
        </form>

        <div class="search-count" id="search-count"></div>
        <div class="search-results" id="search-results"></div>
      </div>
    </section>

    <!-- å³ä¸‹è§’æ‚¬æµ®â€œå›åˆ°æ—¥å†â€æŒ‰é’® -->
    <button
      id="btn-back-floating"
      class="back-floating"
      type="button"
      hidden
    >
      â€¹
    </button>

    <!-- åªä¿ç•™è¿™ä¸€ä»½è„šæœ¬å¼•ç”¨ï¼Œå¹¶ä¸”æ”¾åœ¨æœ€å -->
    <script>
    // ========= çŠ¶æ€ =========
const state = {
  today: new Date(),
  currentMonth: null,
  selectedDate: null,
  byDate: new Map(), // key: "YYYY-MM-DD" -> { messageCount, threadCount, messages }

  // æ˜¾ç¤ºè®¾ç½®
  display: {
    userName: "",
    assistantName: "",
    headerTitle: "Novemberâ¤Night",
    accentKey: "teal",
  },
};

// ========= å…ƒç´ å¼•ç”¨ =========
const el = {
 btnBackFloating: document.getElementById("btn-back-floating"), // æ‚¬æµ®è¿”å›é”®
  monthLabel: document.getElementById("month-label"),
  calendarGrid: document.getElementById("calendar-grid"),
  screenCalendar: document.getElementById("screen-calendar"),
  screenDay: document.getElementById("screen-day"),
  dayTitle: document.getElementById("day-title"),
  dayMessages: document.getElementById("day-messages"),

  btnMore: document.getElementById("btn-more"),
  btnProfile: document.getElementById("btn-profile"),
  btnImport: document.getElementById("btn-import"),
  fileInput: document.getElementById("file-input"),
  btnBackCalendar: document.getElementById("btn-back-calendar"),
  sheetBackdrop: document.getElementById("sheet-backdrop"),
  bottomSheet: document.getElementById("bottom-sheet"),
  sheetSearch: document.getElementById("sheet-search"),

// å…¨æ–‡æœç´¢å¼¹çª—
  searchBackdrop: document.getElementById("search-backdrop"),
  searchModal: document.getElementById("search-modal"),
  searchClose: document.getElementById("search-close"),
  searchForm: document.getElementById("search-form"),
  searchInput: document.getElementById("search-input"),
  searchCount: document.getElementById("search-count"),
  searchResults: document.getElementById("search-results"),

  calendarTitle: document.getElementById("calendar-title"),

  // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
  settingsBackdrop: document.getElementById("settings-backdrop"),
  settingsModal: document.getElementById("settings-modal"),
  settingsClose: document.getElementById("settings-close"),
  settingsForm: document.getElementById("settings-form"),
  settingsUserName: document.getElementById("settings-user-name"),
  settingsAssistantName: document.getElementById("settings-assistant-name"),
  settingsTitleInput: document.getElementById("settings-title"),
  accentSwatches: document.querySelectorAll(".accent-swatch"),

  // æœˆä»½ç¿»é¡µæŒ‰é’®
  btnPrevMonth: document.getElementById("btn-prev-month"),
  btnNextMonth: document.getElementById("btn-next-month"),
};

// ========= é‡ç‚¹è‰²é¢„è®¾ =========
const ACCENT_PRESETS = {
  // å¤œç©ºè“
  black: {
    accent: "#1e293b",
    soft: "rgba(30, 41, 59, 0.14)",
  },
  // è‘¡è„ç´«
  purple: {
    accent: "#5C1A87",
    soft: "rgba(99, 102, 241, 0.16)",
  },
  // æ£®æ—ç»¿
  teal: {
    accent: "#0B6C5B",
    soft: "rgba(20, 184, 166, 0.16)",
  },
  // ç³–éœœç²‰
  pink: {
    accent: "#ED778D",
    soft: "rgba(251, 113, 133, 0.18)",
  },
};

// ========= æ—¥å†é€»è¾‘ =========
function renderMonthLabel() {
  const { year, month } = state.currentMonth;
  if (el.monthLabel) {
    el.monthLabel.textContent = `${year}å¹´${month + 1}æœˆ`;
  }
}

function setCurrentMonth(date) {
  const base = new Date(date.getFullYear(), date.getMonth(), 1);
  state.currentMonth = {
    year: base.getFullYear(),
    month: base.getMonth(),
  };
  renderMonthLabel();
  renderCalendar();
}

function changeMonth(delta) {
  const { year, month } = state.currentMonth;
  const newDate = new Date(year, month + delta, 1);
  setCurrentMonth(newDate);
}

function showCalendarScreen() {
  if (el.screenCalendar) el.screenCalendar.hidden = false;
  if (el.screenDay) el.screenDay.hidden = true;

  // å›åˆ°ä¸»ç•Œé¢æ—¶ï¼Œéšè—æ‚¬æµ®æŒ‰é’®
  if (el.btnBackFloating) {
    el.btnBackFloating.hidden = true;
  }
}

// ========= èŠå¤©æ–‡æœ¬æ ¼å¼åŒ– =========

function escapeHtml(text) {
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// è½»é‡çº§ Markdown æ¸²æŸ“ï¼š**ç²—ä½“**ã€> å¼•ç”¨ã€`code`ã€æ¢è¡Œ
function renderMessageHtml(raw) {
  if (!raw) return "";

  // 1) å…ˆæ•´ä½“è½¬ä¹‰
  let escaped = escapeHtml(raw);

  // 2) è¡Œçº§å¤„ç†ï¼šè¯†åˆ«ä»¥ > å¼€å¤´çš„å¼•ç”¨è¡Œ
  const lines = escaped.split(/\r?\n/).map((line) => {
    // è½¬ä¹‰å ">" å˜æˆäº† "&gt;"
    if (line.startsWith("&gt;")) {
      const content = line.replace(/^&gt;\s*/, "");
      return `<div class="msg-quote">${content}</div>`;
    }
    return line;
  });

  let html = lines.join("<br>");

  // 3) è¡Œå†…å¤„ç†ï¼šç²—ä½“ / æ–œä½“ / è¡Œå†…ä»£ç 
  // **ç²—ä½“**
  html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

  // *æ–œä½“*  ï¼ˆç®€å•ç‰ˆï¼Œé¿å…è·Ÿ ** å†²çªï¼‰
  html = html.replace(
    /(^|[\s])\*(?!\s)(.+?)\*(?=\s|$)/g,
    "$1<em>$2</em>"
  );

  // `code`
  html = html.replace(/`([^`]+)`/g, "<code>$1</code>");

  return html;
}

// ========= å½“æ—¥èŠå¤©ç•Œé¢ï¼ˆæ°”æ³¡ï¼‰ =========
function showDayScreen(dateKey) {
  if (el.screenCalendar) el.screenCalendar.hidden = true;
  if (el.screenDay) el.screenDay.hidden = false;

  // èŠå¤©ç•Œé¢æ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®
  if (el.btnBackFloating) {
    el.btnBackFloating.hidden = false;
  }

  const stats = state.byDate.get(dateKey) || null;
  el.dayMessages.innerHTML = "";

  if (!stats || !Array.isArray(stats.messages) || stats.messages.length === 0) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.textContent = "è¿™ä¸€å¤©è¿˜æ²¡æœ‰èŠå¤©è®°å½•ã€‚";
    el.dayMessages.appendChild(empty);
    return;
  }

  const userLabel =
    state.display.userName && state.display.userName.trim()
      ? state.display.userName.trim()
      : "User";

  const assistantLabel =
    state.display.assistantName && state.display.assistantName.trim()
      ? state.display.assistantName.trim()
      : "Assistant";

  stats.messages.forEach((msg) => {
    const role = msg.role || "assistant";

    // ç³»ç»Ÿæ¶ˆæ¯ï¼šä¸­é—´ç°æ¡
    if (role === "system") {
      const row = document.createElement("div");
      row.className = "bubble-row system";

      const label = document.createElement("div");
      label.className = "system-label";
      label.innerHTML = renderMessageHtml(msg.content || "");
      row.appendChild(label);

      if (msg.time) {
        const meta = document.createElement("div");
        meta.className = "system-meta";
        meta.textContent = msg.time;
        row.appendChild(meta);
      }

      el.dayMessages.appendChild(row);
      return;
    }

    // æ™®é€šå¯¹è¯ï¼šå·¦åŠ©æ‰‹ / å³ç”¨æˆ·
    const row = document.createElement("div");
    row.className = "bubble-row " + role;

    const bubble = document.createElement("div");
    bubble.className =
      "bubble " + (role === "user" ? "bubble-user" : "bubble-assistant");

    const textEl = document.createElement("div");
    textEl.className = "bubble-text";
    textEl.innerHTML = renderMessageHtml(msg.content || "");
    bubble.appendChild(textEl);

    // metaï¼šåå­— Â· æ—¶é—´ Â· ä¼šè¯
    const meta = document.createElement("div");
    meta.className = "bubble-meta";

    const nameSpan = document.createElement("span");
    nameSpan.className = "bubble-name";
    nameSpan.textContent = role === "user" ? userLabel : assistantLabel;
    meta.appendChild(nameSpan);

    if (msg.time) {
      const timeSpan = document.createElement("span");
      timeSpan.className = "bubble-time";
      timeSpan.textContent = msg.time;
      meta.appendChild(timeSpan);
    }

    if (msg.threadTitle || msg.threadIndex != null) {
      const threadSpan = document.createElement("span");
      threadSpan.className = "bubble-thread";
      threadSpan.textContent =
        msg.threadTitle || `ä¼šè¯ ${Number(msg.threadIndex) + 1}`;
      meta.appendChild(threadSpan);
    }

    bubble.appendChild(meta);
    row.appendChild(bubble);
    el.dayMessages.appendChild(row);
  });
}

// ========= æ¸²æŸ“æ—¥å† =========
function renderCalendar() {
  const grid = el.calendarGrid;
  if (!state.currentMonth || !grid) return;
  const { year, month } = state.currentMonth;

  grid.innerHTML = "";

  const firstDay = new Date(year, month, 1);
  const firstWeekday = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const totalCells = Math.ceil((firstWeekday + daysInMonth) / 7) * 7;

  for (let index = 0; index < totalCells; index++) {
    const cell = document.createElement("button");
    cell.type = "button";
    cell.className = "day-cell";

    const dayNumber = index - firstWeekday + 1;

    if (dayNumber < 1 || dayNumber > daysInMonth) {
      cell.classList.add("empty");
      grid.appendChild(cell);
      continue;
    }

    const dateKey =
      year +
      "-" +
      String(month + 1).padStart(2, "0") +
      "-" +
      String(dayNumber).padStart(2, "0");

    const dateLabel = document.createElement("div");
    dateLabel.className = "day-cell-date";
    dateLabel.textContent = String(dayNumber);
    cell.appendChild(dateLabel);

    const countLabel = document.createElement("div");
    countLabel.className = "day-cell-count";
    const stats = state.byDate.get(dateKey);
    if (stats && typeof stats.messageCount === "number") {
      countLabel.textContent = stats.messageCount + " æ¡";
    } else {
      countLabel.textContent = "";
    }
    cell.appendChild(countLabel);

    const dotWrap = document.createElement("div");
    dotWrap.className = "day-cell-dot-wrapper";
    const dot = document.createElement("div");
    dot.className = "day-cell-dot";
    if (stats && typeof stats.threadCount === "number") {
      dot.textContent = stats.threadCount;
    } else {
      dot.textContent = "";
    }
    dotWrap.appendChild(dot);
    cell.appendChild(dotWrap);

    // ä»Šå¤©
    if (
      year === state.today.getFullYear() &&
      month === state.today.getMonth() &&
      dayNumber === state.today.getDate()
    ) {
      cell.classList.add("today");
    }

    // é€‰ä¸­æ€
    if (state.selectedDate === dateKey) {
      cell.classList.add("selected");
    }

    if (state.byDate.get(dateKey)) {
      cell.classList.add("has-data");
    }

    cell.addEventListener("click", () => {
      state.selectedDate = dateKey;
      showDayScreen(dateKey);
      renderCalendar();
    });

    grid.appendChild(cell);
  }
}

// ========= åº•éƒ¨æ›´å¤š =========
function openSheet() {
  el.sheetBackdrop.hidden = false;
  el.bottomSheet.hidden = false;
}

function closeSheet() {
  el.sheetBackdrop.hidden = true;
  el.bottomSheet.hidden = true;
}

// ========= æ˜¾ç¤ºè®¾ç½® & é‡ç‚¹è‰² =========
function applyDisplaySettings() {
  const { display } = state;

  if (el.calendarTitle) {
    el.calendarTitle.textContent =
      display.headerTitle && display.headerTitle.trim()
        ? display.headerTitle.trim()
        : "Novemberâ¤Night";
  }

  const preset = ACCENT_PRESETS[display.accentKey] || ACCENT_PRESETS.teal;
  const root = document.documentElement;
  root.style.setProperty("--accent", preset.accent);
  root.style.setProperty("--accent-soft", preset.soft);

  if (el.accentSwatches && el.accentSwatches.forEach) {
    el.accentSwatches.forEach((btn) => {
      const key = btn.getAttribute("data-accent-key");
      if (key === display.accentKey) {
        btn.classList.add("selected");
      } else {
        btn.classList.remove("selected");
      }
    });
  }
}

function fillSettingsForm() {
  const { display } = state;
  if (el.settingsUserName) {
    el.settingsUserName.value = display.userName || "";
  }
  if (el.settingsAssistantName) {
    el.settingsAssistantName.value = display.assistantName || "";
  }
  if (el.settingsTitleInput) {
    el.settingsTitleInput.value = display.headerTitle || "";
  }
}

function openSettings() {
  fillSettingsForm();
  if (el.settingsBackdrop) el.settingsBackdrop.hidden = false;
  if (el.settingsModal) el.settingsModal.hidden = false;
}

function closeSettings() {
  if (el.settingsBackdrop) el.settingsBackdrop.hidden = true;
  if (el.settingsModal) el.settingsModal.hidden = true;
}

function saveDisplaySettingsFromForm() {
  if (el.settingsUserName) {
    state.display.userName = el.settingsUserName.value.trim();
  }
  if (el.settingsAssistantName) {
    state.display.assistantName = el.settingsAssistantName.value.trim();
  }
  if (el.settingsTitleInput) {
    state.display.headerTitle = el.settingsTitleInput.value.trim();
  }

  try {
    localStorage.setItem(
      "chat-calendar-display",
      JSON.stringify(state.display)
    );
  } catch (err) {
    console.warn("æ— æ³•ä¿å­˜åˆ° localStorageï¼š", err);
  }

  applyDisplaySettings();
}

function loadDisplaySettingsFromStorage() {
  try {
    const raw = localStorage.getItem("chat-calendar-display");
    if (!raw) return;
    const parsed = JSON.parse(raw);
    state.display = {
      ...state.display,
      ...parsed,
    };
  } catch (err) {
    console.warn("è¯»å– localStorage å¤±è´¥ï¼š", err);
  }
}

// ========= è§£æ conversations.json =========

function parseChatExport(text) {
  let raw;
  try {
    raw = JSON.parse(text);
  } catch (err) {
    throw new Error("JSON è§£æå¤±è´¥ï¼Œè¯·ç¡®è®¤æ˜¯ conversations.json æ–‡ä»¶ã€‚");
  }

  let conversations;
  if (Array.isArray(raw)) {
    conversations = raw;
  } else if (Array.isArray(raw.conversations)) {
    conversations = raw.conversations;
  } else {
    throw new Error("æœªæ‰¾åˆ° conversations æ•°ç»„ï¼Œæš‚æ—¶ä¸æ”¯æŒè¿™ç§å¯¼å‡ºæ ¼å¼ã€‚");
  }

  const byDate = new Map();
  const globalThreadIds = new Set();
  let totalMessages = 0;
  let latestMs = 0;

  function ensureStats(dateKey) {
    if (!byDate.has(dateKey)) {
      byDate.set(dateKey, {
        messageCount: 0,
        threadCount: 0,
        threadIds: new Set(),
        messages: [],
      });
    }
    return byDate.get(dateKey);
  }

  function normalizeTimestamp(ts, fallbackMs) {
    if (typeof ts === "number") {
      // å°äº 1e12 å½“ç§’ï¼Œå¤§äºå½“æ¯«ç§’
      return ts < 1e12 ? ts * 1000 : ts;
    }
    if (typeof ts === "string") {
      const d = new Date(ts);
      const ms = d.getTime();
      if (!Number.isNaN(ms)) return ms;
    }
    return fallbackMs || Date.now();
  }

  function extractTextFromMessageContent(content) {
    if (!content) return "";
    if (typeof content === "string") return content;

    // ChatGPT å¯¼å‡ºæ ¼å¼ï¼š{ content_type: "text", parts: ["...", "..."] }
    if (Array.isArray(content.parts)) {
      return content.parts.join("\n\n");
    }
    if (typeof content.text === "string") {
      return content.text;
    }
    return "";
  }

  conversations.forEach((conv, convIndex) => {
    const threadIndex = convIndex;
    const threadTitle = conv.title || `ä¼šè¯ ${threadIndex + 1}`;

    const collected = [];

    if (conv.mapping && typeof conv.mapping === "object") {
      Object.values(conv.mapping).forEach((node) => {
        if (!node || !node.message) return;
        const m = node.message;
        if (!m.author || !m.author.role) return;

        const role = m.author.role; // user | assistant | system | tool ...
        if (role === "tool") return;

        const text = extractTextFromMessageContent(m.content);
        if (!text) return;

        let ts =
          m.create_time ??
          m.update_time ??
          node.create_time ??
          conv.create_time ??
          conv.update_time;

        const ms = normalizeTimestamp(ts, Date.now());

        collected.push({
          role,
          text,
          ms,
        });
      });
    } else if (Array.isArray(conv.messages)) {
      conv.messages.forEach((m) => {
        if (!m || !m.author || !m.author.role) return;
        const role = m.author.role;
        if (role === "tool") return;

        const text = extractTextFromMessageContent(m.content || m);
        if (!text) return;

        const ms = normalizeTimestamp(
          m.create_time ?? m.update_time ?? conv.create_time ?? conv.update_time,
          Date.now()
        );

        collected.push({
          role,
          text,
          ms,
        });
      });
    }

    // æ—¶é—´æ’åº
    collected.sort((a, b) => a.ms - b.ms);

    collected.forEach((item) => {
      const dateObj = new Date(item.ms);
      const y = dateObj.getFullYear();
      const m = dateObj.getMonth() + 1;
      const d = dateObj.getDate();

      const dateKey =
        y +
        "-" +
        String(m).padStart(2, "0") +
        "-" +
        String(d).padStart(2, "0");

      const timeStr =
        String(dateObj.getHours()).padStart(2, "0") +
        ":" +
        String(dateObj.getMinutes()).padStart(2, "0") +
        ":" +
        String(dateObj.getSeconds()).padStart(2, "0");

      const stats = ensureStats(dateKey);
      stats.messageCount += 1;
      stats.threadIds.add(threadIndex);
      globalThreadIds.add(threadIndex);
      totalMessages += 1;

      if (item.ms > latestMs) latestMs = item.ms;

      stats.messages.push({
        role:
          item.role === "system"
            ? "system"
            : item.role === "user"
            ? "user"
            : "assistant",
        content: item.text,
        time: timeStr,
        threadTitle,
        threadIndex,
        _ms: item.ms,
      });
    });
  });

  // æ”¶å°¾ï¼šthreadCount / æ’åº / æ¸…ç†ä¸´æ—¶å­—æ®µ
  for (const [dateKey, stats] of byDate.entries()) {
    stats.threadCount = stats.threadIds.size;
    stats.threadIds = undefined;
    stats.messages.sort((a, b) => a._ms - b._ms);
    stats.messages.forEach((m) => {
      delete m._ms;
    });
  }

  return {
    byDate,
    dayCount: byDate.size,
    messageCount: totalMessages,
    threadCount: globalThreadIds.size,
    latestMs,
  };
}

// ========= å…¨æ–‡æœç´¢ =========

function openSearchModal() {
  if (!el.searchBackdrop || !el.searchModal) return;

  el.searchBackdrop.hidden = false;
  el.searchModal.hidden = false;

  if (el.searchInput) {
    el.searchInput.value = "";
    el.searchInput.focus();
  }
  if (el.searchCount) {
    el.searchCount.textContent = "åœ¨æ‰€æœ‰è§£æå®Œæˆçš„èŠå¤©è®°å½•ä¸­æœç´¢ã€‚";
  }
  if (el.searchResults) {
    el.searchResults.innerHTML = "";
  }
}

function closeSearchModal() {
  if (el.searchBackdrop) el.searchBackdrop.hidden = true;
  if (el.searchModal) el.searchModal.hidden = true;
}

function runFullTextSearch(rawQuery) {
  const q = (rawQuery || "").trim();
  if (!el.searchCount || !el.searchResults) return;

  if (!q) {
    el.searchCount.textContent = "è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚";
    el.searchResults.innerHTML = "";
    return;
  }

  if (!state.byDate || state.byDate.size === 0) {
    el.searchCount.textContent =
      "è¿˜æ²¡æœ‰è§£æä»»ä½•èŠå¤©è®°å½•ï¼Œè¯·å…ˆåœ¨ä¸»ç•Œé¢å¯¼å…¥ conversations.jsonã€‚";
    el.searchResults.innerHTML = "";
    return;
  }

  const needle = q.toLowerCase();
  const results = [];

  for (const [dateKey, stats] of state.byDate.entries()) {
    if (!stats || !Array.isArray(stats.messages)) continue;

    stats.messages.forEach((msg) => {
      const text = msg.content || "";
      if (!text) return;

      if (text.toLowerCase().includes(needle)) {
        results.push({
          dateKey,
          time: msg.time || "",
          role: msg.role || "assistant",
          threadTitle: msg.threadTitle || "",
          threadIndex: msg.threadIndex,
          text,
        });
      }
    });
  }

  // æŒ‰æ—¥æœŸ + æ—¶é—´å­—ç¬¦ä¸²æ’åºï¼ˆYYYY-MM-DD HH:MM:SSï¼‰
  results.sort((a, b) => {
    const ak = `${a.dateKey} ${a.time || ""}`;
    const bk = `${b.dateKey} ${b.time || ""}`;
    if (ak < bk) return -1;
    if (ak > bk) return 1;
    return 0;
  });

  el.searchResults.innerHTML = "";

  if (!results.length) {
    el.searchCount.textContent = `æ²¡æœ‰æ‰¾åˆ°å…³äºã€Œ${q}ã€çš„å†…å®¹ã€‚`;
    const empty = document.createElement("div");
    empty.className = "search-empty";
    empty.textContent = "å¯ä»¥å°è¯•æ¢ä¸€ä¸ªå…³é”®è¯ã€‚";
    el.searchResults.appendChild(empty);
    return;
  }

  const userName =
    state.display.userName && state.display.userName.trim()
      ? state.display.userName.trim()
      : "User";
  const assistantName =
    state.display.assistantName && state.display.assistantName.trim()
      ? state.display.assistantName.trim()
      : "Assistant";

  el.searchCount.textContent = `å…± ${results.length} æ¡åŒ¹é…ç»“æœ`;

  results.forEach((item) => {
    const card = document.createElement("article");
    card.className = "search-result-card";

    const meta = document.createElement("div");
    meta.className = "search-result-meta";

    let roleLabel = "";
    if (item.role === "user") {
      roleLabel = userName;
    } else if (item.role === "assistant") {
      roleLabel = assistantName;
    } else {
      roleLabel = "ç³»ç»Ÿ";
    }

    const pieces = [item.dateKey];
    if (item.time) pieces.push(item.time);
    pieces.push(roleLabel);
    if (item.threadTitle) pieces.push(item.threadTitle);

    meta.textContent = pieces.join(" Â· ");
    card.appendChild(meta);

    const body = document.createElement("div");
    body.className = "search-result-body";
    body.textContent = item.text;
    card.appendChild(body);

    // ç‚¹å‡»ç»“æœï¼šå…³é—­æœç´¢ï¼Œè·³åˆ°å¯¹åº”æ—¥æœŸ
    card.addEventListener("click", () => {
      closeSearchModal();
      state.selectedDate = item.dateKey;
      renderCalendar();
      showDayScreen(item.dateKey);
    });

    el.searchResults.appendChild(card);
  });
}

// ========= äº‹ä»¶ç»‘å®š =========
function initEvents() {
  if (el.btnBackCalendar) {
    el.btnBackCalendar.addEventListener("click", showCalendarScreen);
  }

  if (el.btnMore) {
    el.btnMore.addEventListener("click", openSheet);
  }
  if (el.sheetBackdrop) {
    el.sheetBackdrop.addEventListener("click", closeSheet);
  }
   if (el.sheetSearch) {
    el.sheetSearch.addEventListener("click", () => {
      closeSheet();
      openSearchModal();
    });
  }

  // å…¨æ–‡æœç´¢å¼¹çª—ï¼šå…³é—­ & æäº¤
  if (el.searchBackdrop) {
    el.searchBackdrop.addEventListener("click", closeSearchModal);
  }
  if (el.searchClose) {
    el.searchClose.addEventListener("click", closeSearchModal);
  }
  if (el.searchForm && el.searchInput) {
    el.searchForm.addEventListener("submit", (e) => {
      e.preventDefault();
      runFullTextSearch(el.searchInput.value || "");
    });
  }

  // å¯¼å…¥ conversations.json

  if (el.btnImport && el.fileInput) {
    el.btnImport.addEventListener("click", () => {
      el.fileInput.value = "";
      el.fileInput.click();
    });

    // è¿™é‡Œæ•´å—æ›¿æ¢æˆæ–°çš„ç‰ˆæœ¬ï¼ˆå»æ‰â€œè§£æå®Œæˆâ€alertï¼‰
    el.fileInput.addEventListener("change", (event) => {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = String(reader.result || "");
          const result = parseChatExport(text);

          state.byDate = result.byDate;
          state.selectedDate = null;

          if (result.latestMs) {
            const latestDate = new Date(result.latestMs);
            setCurrentMonth(latestDate);
          } else {
            setCurrentMonth(state.today);
          }

          // è¿™é‡ŒåŸæ¥æœ‰ä¸€ä¸ª alert æç¤ºâ€œè§£æå®Œæˆï¼šXå¤©ã€Yæ¡æ¶ˆæ¯...â€
          // æ ·å¼å’Œæ•´å¥— UI ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬å»æ‰å®ƒï¼Œä¸å½±å“åŠŸèƒ½
          // å¦‚æœä»¥åæƒ³çœ‹ç»Ÿè®¡ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°é‡Œæ‰“å°ï¼š
          // console.log(
          //   `è§£æå®Œæˆï¼š${result.dayCount} å¤©ï¼Œ${result.messageCount} æ¡æ¶ˆæ¯ï¼Œ${result.threadCount} ä¸ªä¼šè¯ã€‚`
          // );
        } catch (err) {
          console.error(err);
          alert("è§£ææ–‡ä»¶æ—¶å‡ºé”™ï¼š" + err.message);
        }
      };
      reader.readAsText(file, "utf-8");
    });
  }

  if (el.btnProfile) {
    el.btnProfile.addEventListener("click", openSettings);
  }
  if (el.settingsBackdrop) {
    el.settingsBackdrop.addEventListener("click", closeSettings);
  }
  if (el.settingsClose) {
    el.settingsClose.addEventListener("click", closeSettings);
  }
  if (el.settingsForm) {
    el.settingsForm.addEventListener("submit", (e) => {
      e.preventDefault();
      saveDisplaySettingsFromForm();
      closeSettings();
    });
  }

  if (el.accentSwatches && el.accentSwatches.forEach) {
    el.accentSwatches.forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-accent-key");
        state.display.accentKey = key;
        applyDisplaySettings();
      });
    });
  }

  // æ‚¬æµ®â€œå›åˆ°æ—¥å†â€æŒ‰é’®
  if (el.btnBackFloating) {
    el.btnBackFloating.addEventListener("click", showCalendarScreen);
  }

  if (el.btnPrevMonth) {
    el.btnPrevMonth.addEventListener("click", () => changeMonth(-1));
  }
  if (el.btnNextMonth) {
    el.btnNextMonth.addEventListener("click", () => changeMonth(1));
  }
}

// ===== ä¸‹é›ªç‰¹æ•ˆ =====
function initSnowEffect() {
  const snowLayer = document.createElement("div");
  snowLayer.className = "snow-layer";
  document.body.appendChild(snowLayer);

  const snowCount = 120;              // â¶ é›ªèŠ±æ•°é‡ï¼šæ›´å¤šä¸€ç‚¹ï¼ˆå¡çš„è¯å¯ä»¥æ”¹å› 80ï¼‰
  const vw = window.innerWidth;

  for (let i = 0; i < snowCount; i++) {
    const flake = document.createElement("div");
    flake.className = "snowflake";

    // â· é›ªèŠ±å°ºå¯¸ï¼š6 ~ 12 åƒç´ ï¼Œæ¯”åŸæ¥æ˜æ˜¾
    const size = 6 + Math.random() * 6;
    flake.style.width = size + "px";
    flake.style.height = size + "px";

    const startLeft = Math.random() * vw;
    flake.style.left = startLeft + "px";

    // â¸ æ‰è½æ—¶é—´ï¼š12 ~ 22 ç§’ï¼Œæ›´æ…¢
    const duration = 12 + Math.random() * 10;
    const delay = Math.random() * 12;
    flake.style.animationDuration = duration + "s";
    flake.style.animationDelay = delay + "s";

    snowLayer.appendChild(flake);
  }
}

// ========= å¯åŠ¨ =========
function bootstrap() {
  const base = state.today;
  setCurrentMonth(base);

  loadDisplaySettingsFromStorage();
  applyDisplaySettings();

  initEvents();
  initSnowEffect();   // â˜… åœ¨è¿™é‡Œå¼€å¯ä¸‹é›ª
}

bootstrap();
    </script>
  </body>
</html>
